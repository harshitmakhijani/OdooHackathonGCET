{% extends "base.html" %}

{% block title %}HR Attendance Management - Dayflow HRMS{% endblock %}

{% block content %}
<div class="container" style="margin-top: 2rem;">
    <div class="page-header">
        <h1><i class="fas fa-clipboard-check"></i> HR Attendance Management</h1>
        <div style="display: flex; gap: 1rem;">
            <button type="button" class="btn btn-success" onclick="markAllPresent()">
                <i class="fas fa-check-double"></i> Mark All Present
            </button>
            <button type="button" class="btn btn-primary" onclick="saveAllAttendance()">
                <i class="fas fa-save"></i> Save All Changes
            </button>
        </div>
    </div>

    <!-- Date Selection Card -->
    <div class="card" style="margin-bottom: 2rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
        <div class="card-body" style="padding: 1.5rem;">
            <form method="GET" id="dateForm">
                <div style="display: flex; gap: 1.5rem; align-items: center; flex-wrap: wrap;">
                    <div style="flex: 1; min-width: 200px;">
                        <label style="margin-bottom: 0.5rem; font-weight: 600;">Select Date</label>
                        <input type="date" name="date" id="selectedDate" class="form-control" 
                               value="{{ selected_date }}" 
                               onchange="document.getElementById('dateForm').submit()"
                               style="border: 2px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.2); color: white; font-weight: 600;">
                    </div>
                    <div style="flex: 1; min-width: 200px;">
                        <label style="margin-bottom: 0.5rem; font-weight: 600;">Filter by Department</label>
                        <select name="department" class="form-control" onchange="document.getElementById('dateForm').submit()"
                                style="border: 2px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.2); color: white; font-weight: 600;">
                            <option value="">All Departments</option>
                            {% for dept in departments %}
                            <option value="{{ dept }}" {% if dept == selected_department %}selected{% endif %}>{{ dept }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div style="flex: 1; min-width: 200px;">
                        <label style="margin-bottom: 0.5rem; font-weight: 600;">Search Employee</label>
                        <input type="text" id="searchEmployee" class="form-control" placeholder="Search by name or ID..."
                               style="border: 2px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.2); color: white;"
                               onkeyup="filterEmployees()">
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Summary Stats -->
    <div class="row" style="margin-bottom: 2rem;">
        <div class="col-md-3">
            <div class="stat-card">
                <div class="stat-icon primary"><i class="fas fa-users"></i></div>
                <div class="stat-content">
                    <h3 id="totalEmployees">{{ employees|length }}</h3>
                    <p>Total Employees</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <div class="stat-icon success"><i class="fas fa-check"></i></div>
                <div class="stat-content">
                    <h3 id="presentCount">0</h3>
                    <p>Marked Present</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <div class="stat-icon danger"><i class="fas fa-times"></i></div>
                <div class="stat-content">
                    <h3 id="absentCount">0</h3>
                    <p>Marked Absent</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <div class="stat-icon warning"><i class="fas fa-clock"></i></div>
                <div class="stat-content">
                    <h3 id="pendingCount">{{ employees|length }}</h3>
                    <p>Pending</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Employee Attendance Grid -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">
                Employee Attendance - {{ selected_date_formatted }}
            </h3>
        </div>
        <div class="card-body" style="padding: 0;">
            {% if employees %}
            <div class="table-responsive">
                <table class="table" id="attendanceTable">
                    <thead>
                        <tr>
                            <th style="width: 40px;">
                                <input type="checkbox" id="selectAll" onchange="toggleSelectAll(this)">
                            </th>
                            <th>Employee</th>
                            <th>Department</th>
                            <th style="width: 150px;">Status</th>
                            <th style="width: 120px;">Check In</th>
                            <th style="width: 120px;">Check Out</th>
                            <th style="width: 250px;">Remarks</th>
                            <th style="width: 100px;" class="text-center">Quick Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for employee in employees %}
                        <tr class="employee-row" data-employee-id="{{ employee.id }}" 
                            data-employee-name="{{ employee.full_name }}" 
                            data-employee-dept="{{ employee.department }}">
                            <td>
                                <input type="checkbox" class="employee-checkbox" value="{{ employee.id }}">
                            </td>
                            <td>
                                <div style="display: flex; align-items: center; gap: 0.75rem;">
                                    <div class="avatar" style="width: 36px; height: 36px; font-size: 14px;">
                                        {{ employee.first_name[0] }}{{ employee.last_name[0] }}
                                    </div>
                                    <div>
                                        <div style="font-weight: 600;">{{ employee.full_name }}</div>
                                        <small class="text-muted">{{ employee.user.employee_id }}</small>
                                    </div>
                                </div>
                            </td>
                            <td>{{ employee.department }}</td>
                            <td>
                                <select class="form-control form-control-sm status-select" 
                                        data-employee-id="{{ employee.id }}"
                                        onchange="updateStats(); handleStatusChange(this)">
                                    <option value="">-- Select --</option>
                                    <option value="Present" {% if existing_attendance.get(employee.id) and existing_attendance[employee.id].status == 'Present' %}selected{% endif %}>Present</option>
                                    <option value="Absent" {% if existing_attendance.get(employee.id) and existing_attendance[employee.id].status == 'Absent' %}selected{% endif %}>Absent</option>
                                    <option value="Half-day" {% if existing_attendance.get(employee.id) and existing_attendance[employee.id].status == 'Half-day' %}selected{% endif %}>Half-day</option>
                                    <option value="Leave" {% if existing_attendance.get(employee.id) and existing_attendance[employee.id].status == 'Leave' %}selected{% endif %}>Leave</option>
                                </select>
                            </td>
                            <td>
                                <input type="time" class="form-control form-control-sm checkin-time" 
                                       data-employee-id="{{ employee.id }}"
                                       value="{% if existing_attendance.get(employee.id) and existing_attendance[employee.id].check_in %}{{ existing_attendance[employee.id].check_in.strftime('%H:%M') }}{% else %}09:00{% endif %}">
                            </td>
                            <td>
                                <input type="time" class="form-control form-control-sm checkout-time" 
                                       data-employee-id="{{ employee.id }}"
                                       value="{% if existing_attendance.get(employee.id) and existing_attendance[employee.id].check_out %}{{ existing_attendance[employee.id].check_out.strftime('%H:%M') }}{% else %}17:00{% endif %}">
                            </td>
                            <td>
                                <input type="text" class="form-control form-control-sm remarks-input" 
                                       data-employee-id="{{ employee.id }}"
                                       placeholder="Add remarks..."
                                       value="{% if existing_attendance.get(employee.id) %}{{ existing_attendance[employee.id].remarks or '' }}{% endif %}">
                            </td>
                            <td class="text-center">
                                <div style="display: flex; gap: 0.25rem; justify-content: center;">
                                    <button class="btn btn-sm btn-success" onclick="quickMark({{ employee.id }}, 'Present')" title="Present">
                                        <i class="fas fa-check"></i>
                                    </button>
                                    <button class="btn btn-sm btn-danger" onclick="quickMark({{ employee.id }}, 'Absent')" title="Absent">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Bulk Actions Bar -->
            <div style="padding: 1.5rem; background: var(--bg-light); border-top: 2px solid var(--border-color);">
                <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                    <strong>Bulk Actions for Selected:</strong>
                    <button class="btn btn-sm btn-success" onclick="bulkMarkStatus('Present')">
                        <i class="fas fa-check"></i> Mark Present
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="bulkMarkStatus('Absent')">
                        <i class="fas fa-times"></i> Mark Absent
                    </button>
                    <button class="btn btn-sm btn-warning" onclick="bulkMarkStatus('Half-day')">
                        <i class="fas fa-clock"></i> Mark Half-day
                    </button>
                    <button class="btn btn-sm btn-info" onclick="bulkMarkStatus('Leave')">
                        <i class="fas fa-calendar-times"></i> Mark Leave
                    </button>
                    <div style="margin-left: auto;">
                        <button class="btn btn-primary" onclick="saveAllAttendance()">
                            <i class="fas fa-save"></i> Save All Changes
                        </button>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="empty-state">
                <i class="fas fa-users"></i>
                <h3>No Employees Found</h3>
                <p>No active employees found for the selected filters.</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<style>
.form-control-sm {
    padding: 0.25rem 0.5rem;
    font-size: 13px;
}

.status-select {
    font-weight: 600;
}

.status-select option[value="Present"] {
    color: var(--success);
}

.status-select option[value="Absent"] {
    color: var(--danger);
}

.btn-sm {
    padding: 0.25rem 0.5rem;
    font-size: 12px;
}

.employee-row {
    transition: background-color 0.2s;
}

.employee-row:hover {
    background-color: var(--bg-light);
}

.employee-checkbox:checked ~ * {
    background-color: rgba(102, 126, 234, 0.1);
}

input[type="date"]::-webkit-calendar-picker-indicator {
    filter: invert(1);
}

select option {
    background: white;
    color: black;
}
</style>

<script>
// Initialize stats on page load
document.addEventListener('DOMContentLoaded', function() {
    updateStats();
    
    // Add change listeners to all status selects
    document.querySelectorAll('.status-select').forEach(select => {
        select.addEventListener('change', function() {
            handleStatusChange(this);
        });
    });
});

function updateStats() {
    const statusSelects = document.querySelectorAll('.status-select');
    let present = 0, absent = 0, pending = 0;
    
    statusSelects.forEach(select => {
        const value = select.value;
        if (value === 'Present' || value === 'Half-day') present++;
        else if (value === 'Absent' || value === 'Leave') absent++;
        else pending++;
    });
    
    document.getElementById('presentCount').textContent = present;
    document.getElementById('absentCount').textContent = absent;
    document.getElementById('pendingCount').textContent = pending;
}

function handleStatusChange(selectElement) {
    const status = selectElement.value;
    const employeeId = selectElement.dataset.employeeId;
    const row = selectElement.closest('tr');
    const checkinInput = row.querySelector('.checkin-time');
    const checkoutInput = row.querySelector('.checkout-time');
    
    // Disable/enable time inputs based on status
    if (status === 'Absent' || status === 'Leave') {
        checkinInput.disabled = true;
        checkoutInput.disabled = true;
        checkinInput.value = '';
        checkoutInput.value = '';
    } else {
        checkinInput.disabled = false;
        checkoutInput.disabled = false;
        if (!checkinInput.value) checkinInput.value = '09:00';
        if (!checkoutInput.value) checkoutInput.value = '17:00';
    }
    
    updateStats();
}

function quickMark(employeeId, status) {
    const row = document.querySelector(`tr[data-employee-id="${employeeId}"]`);
    const statusSelect = row.querySelector('.status-select');
    statusSelect.value = status;
    handleStatusChange(statusSelect);
}

function markAllPresent() {
    if (confirm('Mark all employees as Present?')) {
        document.querySelectorAll('.status-select').forEach(select => {
            select.value = 'Present';
            handleStatusChange(select);
        });
    }
}

function toggleSelectAll(checkbox) {
    document.querySelectorAll('.employee-checkbox').forEach(cb => {
        cb.checked = checkbox.checked;
    });
}

function bulkMarkStatus(status) {
    const checkedBoxes = document.querySelectorAll('.employee-checkbox:checked');
    if (checkedBoxes.length === 0) {
        alert('Please select at least one employee');
        return;
    }
    
    checkedBoxes.forEach(checkbox => {
        const employeeId = checkbox.value;
        const row = document.querySelector(`tr[data-employee-id="${employeeId}"]`);
        const statusSelect = row.querySelector('.status-select');
        statusSelect.value = status;
        handleStatusChange(statusSelect);
    });
}

function filterEmployees() {
    const searchTerm = document.getElementById('searchEmployee').value.toLowerCase();
    const rows = document.querySelectorAll('.employee-row');
    
    rows.forEach(row => {
        const name = row.dataset.employeeName.toLowerCase();
        const dept = row.dataset.employeeDept.toLowerCase();
        
        if (name.includes(searchTerm) || dept.includes(searchTerm)) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}

function saveAllAttendance() {
    const date = document.getElementById('selectedDate').value;
    const rows = document.querySelectorAll('.employee-row');
    const attendanceData = [];
    
    let hasData = false;
    rows.forEach(row => {
        const employeeId = row.dataset.employeeId;
        const statusSelect = row.querySelector('.status-select');
        const status = statusSelect.value;
        
        if (status) {
            hasData = true;
            const checkinTime = row.querySelector('.checkin-time').value;
            const checkoutTime = row.querySelector('.checkout-time').value;
            const remarks = row.querySelector('.remarks-input').value;
            
            attendanceData.push({
                employee_id: employeeId,
                status: status,
                check_in: checkinTime,
                check_out: checkoutTime,
                remarks: remarks
            });
        }
    });
    
    if (!hasData) {
        alert('Please mark attendance for at least one employee');
        return;
    }
    
    if (!confirm(`Save attendance for ${attendanceData.length} employees?`)) {
        return;
    }
    
    // Show loading
    const saveBtn = event.target;
    const originalText = saveBtn.innerHTML;
    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
    saveBtn.disabled = true;
    
    // Send to server
    fetch('/admin/hr-attendance/save', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            date: date,
            attendance: attendanceData
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message || 'Attendance saved successfully!');
            location.reload();
        } else {
            alert(data.message || 'Failed to save attendance');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while saving attendance');
    })
    .finally(() => {
        saveBtn.innerHTML = originalText;
        saveBtn.disabled = false;
    });
}
</script>
{% endblock %}
